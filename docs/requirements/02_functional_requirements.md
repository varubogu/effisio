# 機能要件書

## 1. 概要

本書は、社内Webシステムの機能要件を詳細に定義します。

---

## 2. 認証・認可機能

### 2.1 ログイン機能
**要件ID**: FR-AUTH-001

| 項目 | 内容 |
|------|------|
| 機能名 | ユーザーログイン |
| 説明 | ユーザーが認証情報を提供し、システムにアクセス |
| アクター | 未認証ユーザー |
| 前提条件 | ユーザーがシステムに登録済み |
| 主フロー | 1. ユーザーがログインページにアクセス<br>2. ユーザーが認証情報（ユーザー名/メール、パスワード）を入力<br>3. システムが認証情報を検証<br>4. 認証成功時、JWTトークンを発行<br>5. ユーザーがダッシュボードへリダイレクト |
| 代替フロー | 認証失敗：エラーメッセージを表示し、再入力を促す |
| エラーハンドリング | 入力形式エラー、パスワード不正、ユーザー未検出 |
| 出力 | JWTトークン、リフレッシュトークン、ユーザー情報 |

### 2.2 ログアウト機能
**要件ID**: FR-AUTH-002

- ユーザーがログアウトボタンをクリック
- セッション情報を削除
- トークンを無効化
- ログインページへリダイレクト

### 2.3 トークンリフレッシュ
**要件ID**: FR-AUTH-003

- リフレッシュトークンの有効期限を確認
- 有効な場合は新規JWTトークンを発行
- 無効な場合はログイン画面へリダイレクト
- Access Token: 1時間, Refresh Token: 30日

### 2.4 パスワード変更
**要件ID**: FR-AUTH-004

- ユーザーが旧パスワードを入力
- 新パスワードを設定（要件：8文字以上、大小文字・数字・記号含む）
- bcryptでハッシュ化して保存
- ログイン時に新パスワードで認証

---

## 3. ユーザー管理機能

### 3.1 ユーザー一覧表示
**要件ID**: FR-USER-001

| 項目 | 内容 |
|------|------|
| 機能名 | ユーザー一覧表示 |
| 説明 | 管理者がシステムに登録されたユーザーの一覧を表示 |
| アクター | 管理者ユーザー |
| 前提条件 | ユーザーが管理者ロールで認証済み |
| 出力 | ユーザー情報（ID、ユーザー名、メール、部門、ロール、ステータス） |
| ページネーション | 1ページ20件、最大100件 |
| ソート | ユーザー名、作成日時で可能 |
| フィルタ | ロール、ステータス、部門で検索可能 |
| 検索 | ユーザー名またはメールで部分検索 |

### 3.2 ユーザー作成
**要件ID**: FR-USER-002

- 管理者のみ実行可能
- 必須項目：ユーザー名、メール、パスワード、役職
- オプション項目：フルネーム、部門
- メール重複チェック
- ユーザー名重複チェック
- パスワードバリデーション
- 作成後、メール通知（初期パスワード）

### 3.3 ユーザー詳細表示
**要件ID**: FR-USER-003

- ユーザーIDから詳細情報を取得
- 表示項目：ユーザー名、メール、フルネーム、部門、ロール、ステータス、最終ログイン、作成日時
- 本人またはシステム管理者のみアクセス可

### 3.4 ユーザー情報更新
**要件ID**: FR-USER-004

- 本人またはシステム管理者のみ実行可能
- 更新可能項目：フルネーム、部門、メール（管理者のみ）、ロール（管理者のみ）、ステータス（管理者のみ）
- メール更新時は重複チェック
- 更新前後の情報をログに記録（監査ログ）

### 3.5 ユーザー削除
**要件ID**: FR-USER-005

- システム管理者のみ実行可能
- 物理削除ではなく論理削除（deleted_at カラムで管理）
- 削除前に確認ダイアログを表示
- 削除処理を監査ログに記録

### 3.6 ユーザーステータス管理
**要件ID**: FR-USER-006

- ステータス：active（有効）、inactive（無効）、suspended（停止中）
- 管理者が変更可能
- inactive ユーザーはログイン不可
- ステータス変更を監査ログに記録

---

## 4. ロールベースアクセス制御（RBAC）

### 4.1 ロール定義
**要件ID**: FR-RBAC-001

| ロール | 説明 | 権限 |
|--------|------|------|
| **admin** | システム管理者 | すべての操作 |
| **manager** | マネージャー | ユーザー管理（配下のユーザーのみ）、レポート表示 |
| **user** | 一般ユーザー | ダッシュボード表示、自身の情報編集、データ参照 |
| **viewer** | 閲覧ユーザー | ダッシュボード表示、データ参照のみ |

### 4.2 権限チェック
**要件ID**: FR-RBAC-002

- 各APIエンドポイントで権限チェック実装
- 権限なしの場合は403エラー返却
- ログイン時にユーザーのロールとアクセス権限をメモリに保持
- リクエストのたびに権限をチェック

---

## 5. ダッシュボード機能

### 5.1 ダッシュボード概要
**要件ID**: FR-DASHBOARD-001

| 項目 | 内容 |
|------|------|
| 機能名 | ダッシュボード概要表示 |
| 説明 | ユーザーがシステムの主要情報を一覧表示で確認 |
| 表示項目 | 総ユーザー数、アクティブユーザー数、総リソース数、最終更新日時 |
| 更新頻度 | リアルタイム（キャッシュ：1分） |
| グラフ表示 | ユーザー増減グラフ（過去30日）、ロール別ユーザー分布 |

### 5.2 ウィジェット機能
**要件ID**: FR-DASHBOARD-002

- ウィジェットの表示/非表示を切り替え可能
- ユーザーの設定をデータベースに保存
- ウィジェットの順序をドラッグ&ドロップで変更可能

---

## 6. 監査ログ機能

### 6.1 監査ログ記録
**要件ID**: FR-AUDIT-001

| 項目 | 内容 |
|------|------|
| 記録対象 | ユーザー認証、データベース操作（INSERT/UPDATE/DELETE） |
| 記録項目 | ユーザーID、アクション、リソースタイプ、リソースID、変更内容（JSON）、IPアドレス、タイムスタンプ |
| 保持期間 | 1年間（定期的に古いログを削除） |
| 保護方法 | 削除禁止、読み取り専用（管理者のみ） |

### 6.2 監査ログ表示
**要件ID**: FR-AUDIT-002

- 管理者のみアクセス可能
- ユーザーID、日時範囲、アクションタイプでフィルタ可能
- JSON形式で変更前後の値を表示
- 監査ログの監査ログは記録しない

---

## 7. API機能

### 7.1 REST APIエンドポイント
**要件ID**: FR-API-001

#### 認証エンドポイント
```
POST /api/v1/auth/login           ログイン
POST /api/v1/auth/logout          ログアウト
POST /api/v1/auth/refresh         トークンリフレッシュ
POST /api/v1/auth/password/change パスワード変更
```

#### ユーザーエンドポイント
```
GET    /api/v1/users              ユーザー一覧取得
POST   /api/v1/users              ユーザー作成
GET    /api/v1/users/{id}         ユーザー詳細取得
PUT    /api/v1/users/{id}         ユーザー情報更新
DELETE /api/v1/users/{id}         ユーザー削除
```

#### ダッシュボードエンドポイント
```
GET /api/v1/dashboard/overview    ダッシュボード概要取得
GET /api/v1/dashboard/widgets     ウィジェット情報取得
PUT /api/v1/dashboard/widgets     ウィジェット設定保存
```

#### 監査ログエンドポイント
```
GET /api/v1/audit-logs            監査ログ一覧取得
GET /api/v1/audit-logs/{id}       監査ログ詳細取得
```

### 7.2 API認証
**要件ID**: FR-API-002

- 全APIエンドポイントで認証が必須
- Authorization ヘッダでBearer トークン送信
- トークン検証処理を実装
- 無効なトークンは401エラーを返却

### 7.3 レスポンス形式
**要件ID**: FR-API-003

すべてのAPIが統一されたJSONレスポンス形式で応答：
```json
{
  "code": 200,
  "message": "success",
  "data": { /* レスポンスデータ */ }
}
```

エラーレスポンス：
```json
{
  "code": 400,
  "message": "Invalid request",
  "errors": [{ "field": "...", "message": "..." }]
}
```

---

## 8. エラーハンドリング

### 8.1 標準エラーコード
**要件ID**: FR-ERROR-001

| コード | 説明 |
|--------|------|
| 400 | リクエスト形式エラー |
| 401 | 認証エラー |
| 403 | 権限不足 |
| 404 | リソース未検出 |
| 409 | リソース重複（ユーザー名・メール重複等） |
| 422 | バリデーションエラー |
| 429 | レート制限超過 |
| 500 | 内部サーバーエラー |

### 8.2 エラーログ
**要件ID**: FR-ERROR-002

- すべてのエラーをログに記録
- エラーのトレースIDを生成
- ユーザーには親切なエラーメッセージを表示
- 開発者にはスタックトレースを出力

---

## 9. 性能要件

### 9.1 レスポンスタイム
**要件ID**: FR-PERF-001

| 操作 | 目標 | 上限 |
|------|------|------|
| ログイン | < 200ms | 1000ms |
| ユーザー一覧取得 | < 200ms | 1000ms |
| ユーザー詳細取得 | < 100ms | 500ms |
| ダッシュボード表示 | < 300ms | 1500ms |

### 9.2 キャッシング戦略
**要件ID**: FR-PERF-002

| 対象 | TTL | 更新タイミング |
|------|-----|----------------|
| ユーザー情報 | 5分 | 更新時に即座にクリア |
| ロール権限情報 | 1時間 | デプロイ時 |
| ダッシュボード統計 | 1分 | 自動更新 |

---

## 10. 機能実装優先度

### Priority 1（P1） - 必須
- ログイン/ログアウト
- ユーザー管理（CRUD）
- ロールベースアクセス制御
- 監査ログ

### Priority 2（P2） - 高
- ダッシュボード
- API実装
- エラーハンドリング

### Priority 3（P3） - 中
- パスワード変更
- ウィジェット機能
- キャッシング最適化

### Priority 4（P4） - 低
- 通知機能
- ファイル管理
- 多言語対応
