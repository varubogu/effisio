# 非機能要件書

## 1. パフォーマンス要件

### 1.1 応答時間
**要件ID**: NFR-PERF-001

| 操作 | 目標時間 | 許容上限 | 環境 |
|------|---------|---------|------|
| ページロード | < 200ms | < 500ms | 通常時（同時ユーザー50） |
| API レスポンス | < 100ms | < 500ms | 通常時 |
| レポート生成 | < 5秒 | < 30秒 | 大規模データセット |
| データベースクエリ | < 50ms | < 200ms | インデックス有効時 |

### 1.2 スループット
**要件ID**: NFR-PERF-002

- 同時接続ユーザー数：100ユーザー以上
- 同時リクエスト処理：1000リクエスト/秒
- データベース接続プール：最大50接続

### 1.3 メモリ使用量
**要件ID**: NFR-PERF-003

- アプリケーションメモリ：< 500MB
- キャッシュメモリ（Redis）：< 1GB
- データベース接続メモリ：< 100MB

### 1.4 キャッシング戦略
**要件ID**: NFR-PERF-004

| 対象 | キャッシュ層 | TTL | 優先度 |
|------|------------|-----|--------|
| ユーザー情報 | Redis | 5分 | 高 |
| ロール権限 | メモリ | 1時間 | 高 |
| ダッシュボード統計 | Redis | 1分 | 中 |
| セッション情報 | Redis | トークン有効期限 | 高 |

---

## 2. 信頼性・可用性要件

### 2.1 可用性
**要件ID**: NFR-AVAIL-001

- 目標稼働率（SLA）：99.5% 年間
- 許容ダウンタイム：約1.8時間/月
- ビジネスクリティカル時間帯：08:00～18:00 平日
  - この時間帯の稼働率：99.9%
  - 許容ダウンタイム：約4分/月

### 2.2 障害復旧
**要件ID**: NFR-AVAIL-002

| 障害シナリオ | RTO | RPO |
|-------------|-----|-----|
| アプリケーション停止 | 5分 | 0分 |
| データベース停止 | 15分 | 1分 |
| ディスク満杯 | 10分 | 0分 |
| ネットワーク接続喪失 | 2分 | 0分 |

- RTO: Recovery Time Objective（復旧目標時間）
- RPO: Recovery Point Objective（復旧目標時点）

### 2.3 バックアップ
**要件ID**: NFR-AVAIL-003

- バックアップ頻度：日次フルバックアップ + 時間ごと差分バックアップ
- 保持期間：30日間
- リストア手順：事前検証済み
- リストアテスト：月1回実施

### 2.4 冗長性
**要件ID**: NFR-AVAIL-004

- アプリケーションサーバー：最小2インスタンス（ロードバランサー配下）
- データベース：レプリケーション構成（1マスター + 1以上のスレーブ）
- キャッシュ（Redis）：Sentinel による自動フェイルオーバー

---

## 3. スケーラビリティ要件

### 3.1 水平スケーラビリティ
**要件ID**: NFR-SCALE-001

- ステートレス設計により、アプリケーションサーバーの追加が容易
- 最大10インスタンスまでスケールアウト可能
- ロードバランサーによる自動分散

### 3.2 垂直スケーラビリティ
**要件ID**: NFR-SCALE-002

- マシンスペック向上への対応可能（メモリ、CPU増強）
- データベースのシャーディング準備（将来対応）

### 3.3 ユーザー増加への対応
**要件ID**: NFR-SCALE-003

| 段階 | ユーザー数 | 対応方法 |
|------|-----------|---------|
| 初期 | 100～500 | シングルインスタンス + DB |
| 中期 | 500～5,000 | 2インスタンス + DB レプリケーション |
| 大規模 | 5,000～10,000 | 複数インスタンス + Redis キャッシング |

---

## 4. セキュリティ要件

### 4.1 認証・認可
**要件ID**: NFR-SEC-001

- [ ] 全APIエンドポイントで認証必須
- [ ] JWT トークン使用（署名：RS256）
- [ ] パスワード：bcrypt (cost 12) でハッシュ化
- [ ] ロールベースアクセス制御（RBAC）実装
- [ ] MFA対応準備（将来実装）

### 4.2 データ保護
**要件ID**: NFR-SEC-002

- HTTPS/TLS 1.2 以上の強制
- データベース：パスワード、機密情報は暗号化保存
- 通信中：TLS による暗号化
- 静止時：ディスク暗号化（オンプレの場合）

### 4.3 OWASP Top 10 対策
**要件ID**: NFR-SEC-003

1. **Injection**: パラメータ化クエリ、ORM使用
2. **Broken Authentication**: 強力なパスワード、JWT
3. **Sensitive Data Exposure**: HTTPS、パスワードハッシュ化
4. **XML External Entities**: XML パーサー設定
5. **Broken Access Control**: RBAC、権限チェック
6. **Security Misconfiguration**: デフォルト設定削除
7. **Cross-Site Scripting（XSS）**: HTMLエスケープ、CSP
8. **Insecure Deserialization**: JSON検証
9. **Using Components with Known Vulnerabilities**: 定期更新
10. **Insufficient Logging & Monitoring**: 監査ログ、アラート

### 4.4 監査・コンプライアンス
**要件ID**: NFR-SEC-004

- [ ] すべてのユーザー操作をログに記録
- [ ] 監査ログは改ざん防止（読み取り専用）
- [ ] ログ保持期間：1年間
- [ ] 定期的なセキュリティ監査（年1回以上）
- [ ] ペネトレーションテスト（初回 + 定期）

### 4.5 ネットワークセキュリティ
**要件ID**: NFR-SEC-005

- ファイアウォール設定：必要なポートのみ開放
- WAF (Web Application Firewall)：デプロイ環境による
- DDoS対策：クラウドWAF、レート制限
- IPホワイトリスト：本社ネットワーク（オプション）

---

## 5. 保守性・運用性要件

### 5.1 コード品質
**要件ID**: NFR-MAINT-001

- テストカバレッジ：70% 以上
- ユニットテスト、統合テスト実装
- コードレビュー：全変更に実施
- CI/CD パイプライン自動化

### 5.2 ドキュメント
**要件ID**: NFR-MAINT-002

- [ ] API ドキュメント（Swagger/OpenAPI）
- [ ] アーキテクチャドキュメント
- [ ] 運用手順書
- [ ] トラブルシューティングガイド
- [ ] デプロイメント手順書
- [ ] コード内コメント

### 5.3 ロギング・トレーシング
**要件ID**: NFR-MAINT-003

- 構造化ログ（JSON形式）
- ログレベル：DEBUG、INFO、WARN、ERROR
- リクエストID による分散トレーシング
- ログ集約：ELK Stack または同等
- ログ保持期間：90日

### 5.4 モニタリング・アラート
**要件ID**: NFR-MAINT-004

| メトリクス | 閾値 | アラート |
|-----------|------|----------|
| CPU使用率 | > 80% | Warning |
| メモリ使用率 | > 90% | Warning |
| ディスク使用率 | > 95% | Critical |
| エラーレート | > 1% | Warning |
| 応答時間 | > 1000ms | Warning |
| DB接続数 | > 50 | Warning |

アラート通知：Slack、メール

### 5.5 バージョン管理
**要件ID**: NFR-MAINT-005

- Git による版管理
- Semantic Versioning (v1.0.0形式)
- CHANGELOG 記載（全リリース）
- リリースノート作成

---

## 6. 互換性要件

### 6.1 ブラウザ互換性
**要件ID**: NFR-COMPAT-001

| ブラウザ | 最小バージョン | 対応 |
|---------|------------------|------|
| Chrome | 最新-1 | ✓ |
| Firefox | 最新-1 | ✓ |
| Safari | 最新 | ✓ |
| Edge | 最新 | ✓ |
| IE | 11 | ✗ |

### 6.2 OS互換性
**要件ID**: NFR-COMPAT-002

- サーバーOS: Linux（Ubuntu 20.04 LTS以上）
- デスクトップOS: Windows 10/11, macOS 11以上

### 6.3 API互換性
**要件ID**: NFR-COMPAT-003

- API バージョニング：URL中にバージョン指定（/api/v1/...）
- メジャーバージョンアップ時は新エンドポイント提供
- 従来エンドポイント：2メジャーバージョン分をサポート

---

## 7. デプロイメント要件

### 7.1 デプロイメント環境
**要件ID**: NFR-DEPLOY-001

- 開発環境：Docker Compose（ローカル）
- ステージング環境：Docker Compose or Kubernetes
- 本番環境：Docker または Kubernetes

### 7.2 ビルド・デプロイメント
**要件ID**: NFR-DEPLOY-002

- ビルド時間：< 5分
- デプロイ時間：< 10分（ローリングデプロイ）
- 自動化：GitHub Actions、GitLab CI など
- ロールバック機能：1コマンドで可能

### 7.3 環境設定
**要件ID**: NFR-DEPLOY-003

- 環境変数：.env ファイルまたは環境変数で管理
- シークレット：KMS または Vault で管理
- 設定の暗号化：本番環境

---

## 8. 法的・コンプライアンス要件

### 8.1 データ保護
**要件ID**: NFR-LEGAL-001

- GDPR 対応準備（EU展開時）
- 個人情報保護：社内ポリシーに準拠
- データ削除権：ユーザーがリクエスト時に対応

### 8.2 アクセスログ
**要件ID**: NFR-LEGAL-002

- すべてのシステムアクセスをログに記録
- ログ改ざん防止
- ログの7年保存（社内規定による）

---

## 9. ユーザビリティ要件

### 9.1 UI/UX
**要件ID**: NFR-UX-001

- 応答性の高いインターフェース（< 200ms）
- 直感的な操作性
- エラーメッセージは日本語で明確に
- アクセシビリティ：WCAG 2.1 AA対応

### 9.2 多言語対応
**要件ID**: NFR-UX-002

- 初期：日本語のみ
- 将来：英語対応予定

---

## 10. テスト要件

### 10.1 テストタイプ
**要件ID**: NFR-TEST-001

| テスト種別 | カバレッジ | 頻度 |
|-----------|-----------|------|
| ユニットテスト | 70% | コミット時 |
| 統合テスト | 50% | PR時 |
| E2Eテスト | 主要フロー | リリース前 |
| 負荷テスト | - | リリース前 |
| セキュリティテスト | - | 定期的 |

### 10.2 テスト環境
**要件ID**: NFR-TEST-002

- 開発環境テスト：ローカル、GitHub Actions
- ステージング環境テスト：本番と同様の構成
- リグレッションテスト：自動化
