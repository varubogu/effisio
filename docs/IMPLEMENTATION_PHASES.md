# 実装フェーズ計画

このドキュメントでは、Effisioプロジェクトの実装を段階的に進めるためのフェーズ計画を定義します。

## 目次

- [概要](#概要)
- [Phase 0: 基盤整備](#phase-0-基盤整備)
- [Phase 1: 基本機能](#phase-1-基本機能)
- [Phase 2: 認証機能](#phase-2-認証機能)
- [Phase 3: RBAC実装](#phase-3-rbac実装)
- [Phase 4: 監査ログ](#phase-4-監査ログ)
- [Phase 5: 組織管理](#phase-5-組織管理)
- [Phase 6: 高度な機能](#phase-6-高度な機能)

---

## 概要

### 基本方針

1. **段階的な実装**: 各フェーズは独立して動作可能
2. **テストファースト**: 各フェーズでテストを実装
3. **ドキュメント更新**: 実装後にドキュメントを更新
4. **レビュー**: 各フェーズ完了時にコードレビュー

### 各フェーズの定義

| フェーズ | 期間目安 | 依存関係 | 完了条件 |
|---------|---------|---------|---------|
| Phase 0 | 完了 | なし | 基盤ファイル作成済み |
| Phase 1 | 1-2週 | Phase 0 | ユーザーCRUD完了 |
| Phase 2 | 1週 | Phase 1 | 認証機能完了 |
| Phase 3 | 1週 | Phase 2 | RBAC完了 |
| Phase 4 | 3日 | Phase 3 | 監査ログ完了 |
| Phase 5 | 1週 | Phase 3 | 組織管理完了 |
| Phase 6 | 2-3週 | Phase 5 | 全機能完了 |

---

## Phase 0: 基盤整備

### 状態: ✅ 完了

### 実装内容

#### バックエンド
- [x] プロジェクト構造作成
- [x] Go モジュール初期化
- [x] Dockerfile作成（開発・本番）
- [x] docker-compose.yml作成
- [x] 環境設定ファイル（.env.example）
- [x] Makefile作成
- [x] リンター設定（.golangci.yml）
- [x] 基本ミドルウェア（Logger, Recovery, CORS）
- [x] 初期マイグレーション（users テーブル）

#### フロントエンド
- [x] Next.js プロジェクト初期化
- [x] TypeScript設定（strict mode）
- [x] Tailwind CSS設定
- [x] ESLint/Prettier設定
- [x] ディレクトリ構造作成
- [x] グローバルプロバイダー（TanStack Query）

#### ドキュメント
- [x] 開発環境セットアップガイド
- [x] Gitワークフロー
- [x] コーディングガイドライン
- [x] CI/CD設定

### 成果物
- 開発環境が `make dev` で起動可能
- コード品質チェックが自動化
- ドキュメントが整備済み

---

## Phase 1: 基本機能

### 状態: 🔄 進行中（部分完了）

### 目標
シンプルなユーザーCRUD機能を実装し、基本的なAPI設計パターンを確立する。

### 実装タスク

#### 1.1 データモデル改善 ⏳
- [ ] usersテーブルにカラム追加
  - `full_name VARCHAR(255)`
  - `department VARCHAR(100)`
  - `status VARCHAR(20)` (`is_active` から変更)
  - `last_login TIMESTAMP`
  - `password_hash VARCHAR(255)` (`password` から変更)
- [ ] マイグレーション作成（000002_update_users_table.sql）
- [ ] GORMモデル更新

#### 1.2 APIレスポンス形式統一 ⏳
- [ ] `internal/util/response.go` 作成
  - Success(), Created(), Error() ヘルパー
  - 統一レスポンス構造
- [ ] 既存ハンドラーを統一形式に修正

#### 1.3 エラーハンドリング統一 ⏳
- [ ] `internal/util/errors.go` 作成
  - エラーコード定義
  - カスタムエラー型
- [ ] サービス層でエラーを適切に返す
- [ ] ハンドラー層でエラーを処理

#### 1.4 ページネーション実装 ⏳
- [ ] `internal/util/pagination.go` 作成
- [ ] リポジトリにページネーション対応
- [ ] ユーザー一覧APIに適用

#### 1.5 バリデーション強化 ⏳
- [ ] `internal/util/validator.go` 作成
  - カスタムバリデータ（password, username）
  - バリデーションエラーメッセージ
- [ ] リクエスト構造体にバリデーションタグ追加

#### 1.6 フロントエンド改善 ⏳
- [ ] ユーザー作成フォーム実装
- [ ] ユーザー編集フォーム実装
- [ ] ユーザー削除機能実装
- [ ] ページネーションUI実装
- [ ] エラー表示改善
- [ ] ローディング状態改善

#### 1.7 テスト ⏳
- [ ] ユーザーリポジトリのユニットテスト
- [ ] ユーザーサービスのユニットテスト
- [ ] ユーザーハンドラーの統合テスト
- [ ] E2Eテスト（Cypress）

### 完了条件
- [ ] 全てのユーザーCRUD操作が動作
- [ ] APIレスポンスが統一形式
- [ ] ページネーションが動作
- [ ] バリデーションエラーが適切に表示
- [ ] テストカバレッジ70%以上
- [ ] ドキュメント更新完了

### 推定工数: 1-2週間

---

## Phase 2: 認証機能

### 状態: 📅 未着手

### 目標
JWT認証を実装し、ログイン・ログアウト機能を提供する。

### 実装タスク

#### 2.1 JWT実装
- [ ] `internal/service/jwt.go` 作成
  - Access Token生成
  - Refresh Token生成
  - トークン検証
- [ ] JWT設定（環境変数）
- [ ] RSA鍵ペア生成（本番環境用）

#### 2.2 セッション管理
- [ ] sessionsテーブル作成（マイグレーション）
- [ ] Session モデル作成
- [ ] Session リポジトリ作成
- [ ] セッション有効期限管理

#### 2.3 認証API
- [ ] POST /auth/login 実装
  - パスワード検証
  - トークン発行
  - セッション作成
- [ ] POST /auth/refresh 実装
  - リフレッシュトークン検証
  - 新トークン発行
  - トークンローテーション
- [ ] POST /auth/logout 実装
  - セッション削除
  - Cookie削除

#### 2.4 認証ミドルウェア
- [ ] `internal/middleware/auth.go` 作成
  - RequireAuth() - 認証必須
  - トークン検証
  - コンテキストにユーザー情報設定

#### 2.5 フロントエンド
- [ ] ログインページ作成
- [ ] 認証ストア作成（Zustand）
  - ログイン状態管理
  - トークン管理
  - 自動リフレッシュ
- [ ] Axiosインターセプター
  - トークン自動付与
  - 401エラー時の自動ログアウト
- [ ] Protected Route実装
- [ ] ログアウト機能

#### 2.6 テスト
- [ ] JWTサービスのユニットテスト
- [ ] 認証APIの統合テスト
- [ ] ミドルウェアのテスト
- [ ] フロントエンド認証フローのE2Eテスト

### 完了条件
- [ ] ログイン・ログアウトが動作
- [ ] トークンリフレッシュが動作
- [ ] 未認証時のリダイレクトが動作
- [ ] テストカバレッジ70%以上
- [ ] AUTH_DESIGN.mdの実装完了

### 推定工数: 1週間

---

## Phase 3: RBAC実装

### 状態: 📅 未着手

### 目標
ロールベースアクセス制御を実装し、権限管理を行う。

### 実装タスク

#### 3.1 データベース
- [ ] rolesテーブル作成
- [ ] permissionsテーブル作成
- [ ] role_permissionsテーブル作成
- [ ] 初期データ投入（シードスクリプト）

#### 3.2 権限管理サービス
- [ ] Permission モデル作成
- [ ] Role モデル作成
- [ ] Permission リポジトリ作成
- [ ] Permission サービス作成
  - ユーザー権限取得
  - ロール権限取得

#### 3.3 認可ミドルウェア
- [ ] RequirePermission() 実装
- [ ] RequireRole() 実装
- [ ] リソースオーナーチェック

#### 3.4 API保護
- [ ] 各エンドポイントに権限チェック追加
- [ ] usersテーブルのroleカラム活用
- [ ] ユーザー作成時のデフォルトロール設定

#### 3.5 フロントエンド
- [ ] 権限チェックコンポーネント
- [ ] ロールによるUI表示制御
- [ ] 権限不足時のエラー表示

#### 3.6 管理画面
- [ ] ロール管理画面
- [ ] 権限管理画面
- [ ] ユーザーのロール変更機能

#### 3.7 テスト
- [ ] 権限サービスのテスト
- [ ] 認可ミドルウェアのテスト
- [ ] 権限別APIアクセステスト

### 完了条件
- [ ] 4つのロール（admin, manager, user, viewer）が動作
- [ ] 権限チェックが正しく動作
- [ ] 権限不足時に403エラーが返る
- [ ] テストカバレッジ70%以上
- [ ] 権限マトリクスドキュメント作成

### 推定工数: 1週間

---

## Phase 4: 監査ログ

### 状態: 📅 未着手

### 目標
システムの全ての重要操作を記録し、監査可能にする。

### 実装タスク

#### 4.1 データベース
- [ ] audit_logsテーブル作成
  - JSONB型で変更前後の値を保存
  - パーティショニング検討

#### 4.2 監査ログサービス
- [ ] AuditLog モデル作成
- [ ] AuditLog リポジトリ作成
- [ ] AuditLog サービス作成
  - LogLoginSuccess()
  - LogLoginFailed()
  - LogUserCreate()
  - LogUserUpdate()
  - LogUserDelete()
  - 等々

#### 4.3 ログ記録実装
- [ ] ミドルウェアで自動記録（オプション）
- [ ] 各ハンドラーで明示的に記録
- [ ] ログ記録の非同期化（パフォーマンス対策）

#### 4.4 監査ログ閲覧API
- [ ] GET /audit-logs 実装
  - フィルタリング（ユーザー、アクション、期間）
  - ページネーション
  - ソート

#### 4.5 フロントエンド
- [ ] 監査ログ一覧画面
- [ ] フィルタリングUI
- [ ] ログ詳細表示
- [ ] エクスポート機能（CSV）

#### 4.6 テスト
- [ ] 監査ログサービスのテスト
- [ ] ログ記録の自動テスト
- [ ] 監査ログAPIのテスト

### 完了条件
- [ ] 全ての重要操作がログ記録される
- [ ] 監査ログが閲覧可能
- [ ] フィルタリング・検索が動作
- [ ] パフォーマンスへの影響が最小限
- [ ] テストカバレッジ70%以上

### 推定工数: 3日

---

## Phase 5: 組織管理

### 状態: 📅 未着手

### 目標
階層的な組織構造を管理し、部門ごとのアクセス制御を実現する。

### 実装タスク

#### 5.1 データベース
- [ ] organizationsテーブル作成
  - 自己参照外部キー
  - パス保存（検索高速化）
- [ ] usersテーブルとの関連付け

#### 5.2 組織管理機能
- [ ] Organization モデル作成
- [ ] Organization リポジトリ作成
- [ ] Organization サービス作成
  - 階層構造の取得
  - 親子関係の検証
  - パス自動生成

#### 5.3 組織API
- [ ] GET /organizations - 組織ツリー取得
- [ ] POST /organizations - 組織作成
- [ ] PUT /organizations/:id - 組織更新
- [ ] DELETE /organizations/:id - 組織削除

#### 5.4 組織ベースの権限制御
- [ ] 組織単位でのアクセス制御
- [ ] ユーザーが属する組織配下のデータのみ閲覧可能

#### 5.5 フロントエンド
- [ ] 組織ツリー表示
- [ ] 組織CRUD画面
- [ ] ドラッグ&ドロップで組織移動
- [ ] ユーザーの組織割り当て

#### 5.6 テスト
- [ ] 組織サービスのテスト
- [ ] 階層構造のテスト
- [ ] 組織権限のテスト

### 完了条件
- [ ] 組織の階層構造が管理可能
- [ ] 組織単位のアクセス制御が動作
- [ ] UI上で組織ツリーが表示される
- [ ] テストカバレッジ70%以上

### 推定工数: 1週間

---

## Phase 6: 高度な機能

### 状態: 📅 未着手

### 目標
システムを本番運用可能なレベルまで引き上げる。

### 実装タスク

#### 6.1 ダッシュボード
- [ ] GET /dashboard/overview API
- [ ] 統計情報の集計
- [ ] グラフ・チャート表示
- [ ] リアルタイム更新（WebSocket検討）

#### 6.2 通知機能
- [ ] 通知テーブル作成
- [ ] 通知API実装
- [ ] メール通知（オプション）
- [ ] プッシュ通知（オプション）

#### 6.3 ファイルアップロード
- [ ] S3互換ストレージ連携
- [ ] ファイルアップロードAPI
- [ ] サムネイル生成
- [ ] ファイルダウンロード

#### 6.4 検索機能
- [ ] 全文検索（PostgreSQL FTS または Elasticsearch）
- [ ] 高度なフィルタリング
- [ ] 検索結果のハイライト

#### 6.5 エクスポート機能
- [ ] CSV エクスポート
- [ ] Excel エクスポート
- [ ] PDF エクスポート（レポート）

#### 6.6 パフォーマンス最適化
- [ ] Redis キャッシュ実装
- [ ] クエリ最適化
- [ ] インデックス追加
- [ ] ページネーション改善（カーソルベース）

#### 6.7 セキュリティ強化
- [ ] レート制限実装
- [ ] CSRF対策
- [ ] セキュリティヘッダー強化
- [ ] 脆弱性スキャン

#### 6.8 監視・ログ
- [ ] Prometheus メトリクス
- [ ] Grafana ダッシュボード
- [ ] ELKスタック（オプション）
- [ ] アラート設定

#### 6.9 国際化
- [ ] i18n対応（日本語・英語）
- [ ] タイムゾーン対応
- [ ] 多通貨対応（必要な場合）

### 完了条件
- [ ] 全ての機能が本番環境で動作
- [ ] パフォーマンスが要件を満たす
- [ ] セキュリティ監査合格
- [ ] 監視・ログシステムが稼働
- [ ] ドキュメント完全版完成

### 推定工数: 2-3週間

---

## マイルストーン

### MVP（Minimum Viable Product）
**期限**: Phase 3完了時
**内容**:
- ユーザー管理
- 認証・認可
- 基本的なRBAC

### Alpha版
**期限**: Phase 4完了時
**内容**:
- MVP + 監査ログ
- 内部テスト開始

### Beta版
**期限**: Phase 5完了時
**内容**:
- Alpha版 + 組織管理
- 限定公開テスト

### 正式リリース
**期限**: Phase 6完了時
**内容**:
- 全機能実装完了
- 本番環境デプロイ

---

## 各フェーズでの成果物

### コード
- [ ] 実装コード（Backend + Frontend）
- [ ] ユニットテスト
- [ ] 統合テスト
- [ ] E2Eテスト

### ドキュメント
- [ ] API仕様書更新
- [ ] 実装ガイド更新
- [ ] データモデル更新
- [ ] CHANGELOG更新

### デプロイ
- [ ] マイグレーション実行
- [ ] シードデータ投入
- [ ] 環境変数設定
- [ ] CI/CD更新

---

## リスクと対策

### Phase 1のリスク
- **リスク**: APIレスポンス形式の変更が影響範囲大
- **対策**: 段階的に移行、既存エンドポイントは一時的に並行運用

### Phase 2のリスク
- **リスク**: JWT実装の脆弱性
- **対策**: セキュリティレビュー、ペネトレーションテスト実施

### Phase 3のリスク
- **リスク**: 権限設計の複雑化
- **対策**: シンプルな権限モデルから開始、段階的に複雑化

### Phase 4のリスク
- **リスク**: 監査ログによるパフォーマンス低下
- **対策**: 非同期処理、パーティショニング

### Phase 5のリスク
- **リスク**: 組織階層の深さによるクエリ性能低下
- **対策**: パス保存、CTEの活用

### Phase 6のリスク
- **リスク**: 機能追加によるスコープクリープ
- **対策**: 優先度付け、MVP後の機能はオプション扱い

---

## 次のステップ

### 現在地: Phase 1（進行中）

**今すぐやるべきこと:**

1. Phase 1のタスクを完了させる
   - データモデル改善
   - APIレスポンス形式統一
   - エラーハンドリング統一
   - ページネーション実装

2. テストの充実
   - ユニットテスト追加
   - 統合テスト追加

3. ドキュメント更新
   - 実装した内容をドキュメントに反映
   - API仕様書更新

**推奨作業順序:**

```
1. データモデル改善（マイグレーション作成）
   ↓
2. APIレスポンス形式統一（ヘルパー関数作成）
   ↓
3. エラーハンドリング統一
   ↓
4. ページネーション実装
   ↓
5. バリデーション強化
   ↓
6. フロントエンド改善
   ↓
7. テスト追加
   ↓
8. Phase 1完了、Phase 2開始
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2024-01-16 | 1.0.0 | 初版作成 |
