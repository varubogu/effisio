.PHONY: help build run test lint clean migrate-up migrate-down migrate-create seed dev

# å¤‰æ•°å®šç¾©
BINARY_NAME=effisio-api
MAIN_PATH=./cmd/server/main.go
MIGRATION_DIR=./migrations
DB_URL ?= postgres://postgres:postgres@localhost:5432/effisio_dev?sslmode=disable

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
help:
	@echo "Backend - åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:"
	@echo ""
	@echo "  make build         - ãƒã‚¤ãƒŠãƒªã‚’ãƒ“ãƒ«ãƒ‰"
	@echo "  make run           - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ"
	@echo "  make dev           - é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆhot reloadï¼‰"
	@echo "  make test          - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
	@echo "  make test-coverage - ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
	@echo "  make lint          - ãƒªãƒ³ã‚¿ãƒ¼ã‚’å®Ÿè¡Œ"
	@echo "  make clean         - ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’å‰Šé™¤"
	@echo ""
	@echo "  make migrate-up    - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ"
	@echo "  make migrate-down  - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯"
	@echo "  make migrate-create NAME=<name> - æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ"
	@echo "  make seed          - ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥"
	@echo ""
	@echo "  make deps          - ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo "  make tidy          - go.mod ã‚’æ•´ç†"
	@echo ""

# ãƒ“ãƒ«ãƒ‰
build:
	@echo "ğŸ—ï¸  ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ã¾ã™..."
	go build -ldflags="-s -w" -o bin/$(BINARY_NAME) $(MAIN_PATH)
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†: bin/$(BINARY_NAME)"

# å®Ÿè¡Œ
run: build
	@echo "ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™..."
	./bin/$(BINARY_NAME)

# é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼ˆhot reload with Airï¼‰
dev:
	@echo "ğŸ”¥ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¦ã„ã¾ã™ï¼ˆhot reloadæœ‰åŠ¹ï¼‰..."
	@if ! command -v air > /dev/null; then \
		echo "âš ï¸  Air ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."; \
		go install github.com/cosmtrek/air@latest; \
	fi
	air -c .air.toml

# ãƒ†ã‚¹ãƒˆ
test:
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
	go test -v -race -timeout 30s ./...

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆ
test-coverage:
	@echo "ğŸ§ª ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
	go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ: coverage.html"

# ãƒªãƒ³ã‚¿ãƒ¼
lint:
	@echo "ğŸ” ãƒªãƒ³ã‚¿ãƒ¼ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
	@if ! command -v golangci-lint > /dev/null; then \
		echo "âš ï¸  golangci-lint ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."; \
		go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest; \
	fi
	golangci-lint run ./...
	@echo "âœ… ãƒªãƒ³ã‚¿ãƒ¼å®Œäº†"

# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
fmt:
	@echo "âœ¨ ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¦ã„ã¾ã™..."
	go fmt ./...
	@echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Œäº†"

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
clean:
	@echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™..."
	rm -rf bin/
	rm -f coverage.out coverage.html
	go clean -cache -testcache
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
deps:
	@echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."
	go mod download
	@echo "âœ… ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

# go.mod ã‚’æ•´ç†
tidy:
	@echo "ğŸ§¹ go.mod ã‚’æ•´ç†ã—ã¦ã„ã¾ã™..."
	go mod tidy
	@echo "âœ… go.mod ã®æ•´ç†å®Œäº†"

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
migrate-up:
	@echo "ğŸ“Š ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
	@if ! command -v migrate > /dev/null; then \
		echo "âš ï¸  golang-migrate ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•: https://github.com/golang-migrate/migrate/tree/master/cmd/migrate"; \
		exit 1; \
	fi
	migrate -path $(MIGRATION_DIR) -database "$(DB_URL)" up
	@echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†"

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
migrate-down:
	@echo "âª ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¦ã„ã¾ã™..."
	@if ! command -v migrate > /dev/null; then \
		echo "âš ï¸  golang-migrate ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•: https://github.com/golang-migrate/migrate/tree/master/cmd/migrate"; \
		exit 1; \
	fi
	migrate -path $(MIGRATION_DIR) -database "$(DB_URL)" down 1
	@echo "âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Œäº†"

# æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
migrate-create:
	@if [ -z "$(NAME)" ]; then \
		echo "âŒ ã‚¨ãƒ©ãƒ¼: NAME ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™"; \
		echo "ä½¿ç”¨ä¾‹: make migrate-create NAME=create_users_table"; \
		exit 1; \
	fi
	@if ! command -v migrate > /dev/null; then \
		echo "âš ï¸  golang-migrate ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
		echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•: https://github.com/golang-migrate/migrate/tree/master/cmd/migrate"; \
		exit 1; \
	fi
	@echo "ğŸ“ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™: $(NAME)"
	migrate create -ext sql -dir $(MIGRATION_DIR) -seq $(NAME)
	@echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"

# ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥
seed:
	@echo "ğŸŒ± ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã—ã¦ã„ã¾ã™..."
	@if [ -f "./scripts/seed.sh" ]; then \
		bash ./scripts/seed.sh; \
	else \
		echo "âš ï¸  scripts/seed.sh ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
	fi
	@echo "âœ… ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥å®Œäº†"

# Dockerç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆï¼ˆCIç”¨ï¼‰
test-ci:
	@echo "ğŸ§ª CIç’°å¢ƒã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
	go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
security:
	@echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
	@if ! command -v gosec > /dev/null; then \
		echo "âš ï¸  gosec ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."; \
		go install github.com/securego/gosec/v2/cmd/gosec@latest; \
	fi
	gosec ./...
	@echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†"
